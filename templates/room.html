{% extends "base.html" %}
{% block content %}
<div class="page-wrapper">
  <div class="chat-shell">
    <header class="chat-header">
      <div class="room-info">
        <p class="room-label">Room Code</p>
        <h2 class="room-code">#{{ code }}</h2>
      </div>
      <div class="room-actions">
        <button class="badge badge-soft" type="button">
          Live
          <span class="dot"></span>
        </button>
      </div>
    </header>

    <div class="chat-body">
      <div class="messages" id="messages"></div>
    </div>

    <form class="chat-input-row" onsubmit="handleSubmit(event)">
      <input
        type="text"
        placeholder="Type a message..."
        name="message"
        id="message"
        autocomplete="off"
      />
      <button
        type="button"
        name="send"
        id="send-btn"
        class="btn primary send-btn"
        onclick="sendMessage()"
      >
        <span>Send</span>
      </button>
    </form>
  </div>
</div>

<script type="text/javascript">
  var socketio = io();

  const messagesContainer = document.getElementById("messages");

  const createMessage = (name, msg, timestamp = null) => {
    const timeString =
      timestamp ||
      new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });

    const wrapper = document.createElement("div");
    wrapper.classList.add("message-row");

    wrapper.innerHTML = `
      <div class="message-bubble">
        <div class="message-meta">
          <span class="author">${name}</span>
          <span class="time">${timeString}</span>
        </div>
        <div class="message-text">${msg}</div>
      </div>
    `;

    messagesContainer.appendChild(wrapper);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  };

  socketio.on("message", (data) => {
    createMessage(data.name, data.message);
  });

  const sendMessage = () => {
    const input = document.getElementById("message");
    if (!input.value.trim()) return;

    socketio.emit("message", { data: input.value.trim() });
    input.value = "";
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    sendMessage();
  };
</script>

{% for msg in messages %}
<script type="text/javascript">
  createMessage("{{ msg.name }}", "{{ msg.message }}");
</script>
{% endfor %}
{% endblock %}
